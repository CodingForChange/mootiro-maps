{% extends "global.html" %}

{% load i18n %}
{% load komoo_map_tags %}
{% load comment_tags %}
{% load vote_tags %}
{% load proposal_tags %}
{% load komoo_tags %}
{% load moderation_tags %}
{% load markitup_tags %}
{% load upload_tags %}

{% block title %}{{ need.title }} {% endblock %}

{% block menu %} {% menu need "need" %} {% endblock %}

{% block content %}
  {% komoo_map geojson 'type=view' 'width=100%' 'height=100%' 'zoom=13' 'panel=False' 'ajax=True' 'lazy=True' %}
  <div id="main-content">
    <div class="need main-column">
      <h2 class="title">{{ need.title }}</h2>

      <div class="clear-both"></div>
      <ul class="horizontal" id="categories">
        {% for c in need.categories.all %}
        <li><img src="{{ STATIC_URL }}{{ c.image }}" title="{{ c.name }}" /></li>
        {% endfor %}
      </ul>

      <div class="view-edit-btn">
        {% history need %}
        <a href="{% if community %}{% url edit_need community.slug need.slug %}{% else %}{% url edit_need need.slug %}{% endif %}" class="btn login-required"><i class="icon-pencil"></i></a>
      </div>

      <div class="clear-both"></div>
      {% vote need %}

      <div class="apart">
        <div><span class="meta-info">{% trans 'Target audiences' %}</span> {{ need.target_audiences.all|join:", " }}</div>
        <div>{% trans 'created by' %} <a href="#">{% firstof need.creator.get_full_name need.creator.username 'someone' %}</a> {% trans 'on' %} {{ need.creation_date|date:'j/n/Y' }}</div>
      </div>
      <div class="mark-down">{{ need.description|render_markup|safe }}</div>

      <div class="view-footer">
          {% image_gallery need %}
      </div>

      <div class="view-extras">
        {% track_buttons need %}
        {% report_content need %}
        {% delete_button need %}
        {% social_buttons %}
        {% comments need %}
      </div>
    </div>

  <div class="right-bar">
    <div id="map-preview">{% komoo_map geojson 'type=preview' %}</div>
    <a class="see-on-map" href="#">{% trans "see on map" %}</a>
    {% taglist need community %}
    <div class="block">
      <h3>{% trans "Proposals" %}</h3>
      {% for proposal in need.proposals.all %}
        {% proposal_summary proposal %}
      {% endfor %}
      <div class="centralizer">
        <a class="button" href="{% if community %}{% url new_proposal community.slug need.slug %}{% else %}{% url new_proposal need.slug %}{% endif %}">
        {% trans "New proposal" %}
        </a>
      </div>
    </div>
    {% with similar_needs=need.tags.similar_objects %}
      {% if similar_needs %}
      <div id="related-needs" class="block">
        <h3>{% trans "Related needs" %}</h3>
        <ul>
          {% for n in similar_needs %}
          <li {% if forloop.counter > 3 %}class="overflow hidden"{% endif %}>
            <a href="{% url view_need n.slug %}"> {{ n.title }} </a>
            {% if n.community.all.count %}
              <span class="attenuate">
              {% for comm in n.community.all %}
                <a href="{% url view_community comm.slug %}">
                  {{ comm.name }}
                </a>
                {% if not forloop.last %}&nbsp;|&nbsp;{% endif %}
              {% endfor %}
              </span>
            {% endif %}
          </li>
          {% empty %}
          <li>{% trans "No related needs." %}</li>
          {% endfor %}
        </ul>
        <div class=""><span class="show-more clickable">{% trans 'see all' %}</span></div>
        <div class="hidden"><span class="show-less clickable">{% trans 'see less' %}</span></div>
        <div class="clear-both"></div>
      </div>
      {% endif %}
    {% endwith %}
  </div>

</div>
{% endblock %}

{% block page_scripts %}
    {% comments_staticfiles %}

    <script type="text/javascript">
      $('.view-footer img').each(function(idx, obj){
        if(obj.offsetHeight > obj.offsetWidth){
          $(obj).css('height', '160px').css('width', 'auto')
                .css('padding-left', Math.abs(obj.offsetWidth - 200) /2 )
                .css('padding-right', Math.abs(obj.offsetWidth - 200) /2 );
        } else {
          $(obj).css('height', 'auto').css('width', '200px')
                .css('padding-bottom', Math.abs(obj.offsetHeight - 200) /2)
                .css('padding-top', Math.abs(obj.offsetHeight - 200) /2);
        }
      });

      $('#related-needs .show-more, #related-needs .show-less').on("click", function (e) {
        $('#related-needs li.overflow').slideToggle("fast");
        $('#related-needs .show-less').parent().toggle();
        $('#related-needs .show-more').parent().toggle();
      });
    </script>
{% endblock %}
