{% load komoo_map_tags %}

<div id="map-preview" class="map-tooltip">{% komoo_map '{"features": [{}, {}]}' 'type=preview' 'width=400px' 'height=400px'%}<div class="close-bttn"><i class="icon-remove"></i></div></div>
<script type="text/javascript" charset="utf-8">
  $(function () {
      var $mapTooltip = $(".map-tooltip").hide();
       $(".map-tooltip .close-bttn").click(function () {
       $mapTooltip.hide();
      });

      var openMapBox = function (geojson, e) {
        var top = e.pageY - $mapTooltip.outerHeight(true) / 2;
        var left = e.pageX + 20;
        preview.clear();
        preview.googleMap.setMapTypeId(google.maps.MapTypeId.HYBRID);
        $mapTooltip.css({"left": left, "top": top}).show();
        google.maps.event.trigger(preview.googleMap, "resize");
        preview.loadGeoJSON(JSON.parse(geojson.replace(/\'/g, '"')), true);
        preview.features.show();
      };

      $(".preview-on-map[data-geojson='{}'], .preview-on-map-ajax[data-model-name='organization']").addClass("disabled").removeAttr("href");
      $(".preview-on-map[data-geojson!='{}']").click(function (e) {
        var $this = $(this);
        var geojson = $this.attr("data-geojson");
        openMapBox(geojson, e);
        return false;
      });
      $(".preview-on-map-ajax[data-model-name!='organization']").click(function (e) {
        var $this = $(this);
        var appName = $this.attr("data-app-name");
        var modelName = $this.attr("data-model-name");
        var objectId = $this.attr("data-object-id");
        var geojson = $this.attr("data-geojson");
        if (geojson) {
          openMapBox(geojson, e);
        } else {
          var url = dutils.urls.resolve('geojson',
              {app_label: appName, model_name: modelName, obj_id: objectId});
          $.ajax({
            url: url,
            success: function (data, textStatus, jqXHR) {
              $this.attr("data-geojson", data);
              openMapBox(data, e);
            },
            dataType: 'text'
          });
        }
        return false;
      });
  });
</script>

