{% load i18n %}
{% block api_js %}
  <!-- Google Maps API javascript -->
  {% if type != 'disabled' %}
  <script type="text/javascript">
    if (!window.google || !window.google.maps) {
      document.write("<s" + "cript type=\"text/javascript\" src=\"http://maps.google.com/maps/api/js?sensor=false&libraries=drawing&language={{ LANGUAGE_CODE }}\" " + "><" + "/script>");
      document.write("<s" + "cript type=\"text/javascript\" src=\"http://www.google.com/jsapi\"" + "><" + "/script>");
    }
    if (!window.komoo) {
      document.write("<s" + "cript type=\"text/javascript\" src=\"{{ STATIC_URL }}js/infobox_packed.js\" defer=\"defer\"" + "><" + "/script>");
      document.write("<s" + "cript type=\"text/javascript\" src=\"{{ STATIC_URL }}js/markerclusterer_packed.js\" defer=\"defer\"" + "><" + "/script>");
      document.write("<s" + "cript type=\"text/javascript\" src=\"{{ STATIC_URL }}js/multimarker.js\" defer=\"defer\"" + "><" + "/script>");
      document.write("<s" + "cript type=\"text/javascript\" src=\"{{ STATIC_URL }}js/komoo_map.js\" defer=\"defer\"" + "><" + "/script>");
    }
  </script>
  {% endif %}
{% endblock %}
{% block html %}
  <!-- HTML map container -->
  <div id="map-container-{{ type }}" class="{% if panel %}with-panel{% endif %}" style="overflow:hidden;">
    {% if panel %}
      {% include "komoo_map/panel.html" %}
      <script type="text/javascript" src="{{STATIC_URL}}/js/map_filter.js"></script>
    {% endif %}
    <div id="map-canvas-{{ type }}"
      style="
      {% if width %}width: {{ width }}; height: {{ height }};
      {% endif %}
      "
      class="komoo-map-googlemap">
        {% if type == 'disabled' %} MAP DISABLED {% endif %}
    </div>
    <div style="clear: both;"></div>
    </div>
      {% if edit_button %}
      <div><a style="width:91%; margin-top:5px;" href="#" class="button" id="map-edit-button">{% trans "Open the map editor" %}</a></div>
      {% endif %}
    {% if editable %}
    <div id="dinamic-form"></div>
      {% endif %}
{% endblock %}

{% block map_js %}
  <!-- Map creation script -->
  <script type="text/javascript">
    {% if editable %}
    var editor;
    {% endif %}
    function initialize_map_{{ type }}() {
      var mapCanvasId = "map-canvas-{{ type }}";
      var mapContainerId = "map-container-{{ type }}";
      var mapElem = document.getElementById(mapCanvasId);

  {% if type != 'disabled' %}
      var geojson = {{ geojson|safe }};
      //var geojson = JSON.parse(geojson_);

      // Dont display the preview map if the geometry is empty.
      if ((geojson.features && geojson.features.length > 0) || mapCanvasId != 'map-canvas-preview') {
        $('#dinamic-form').hide()
        // Options.
        {% if type != 'preview' %}
        var mapOptions = {
          editable: true,
          {% if type == 'editor' and not panel %}
          fetchOverlays: false,
          {% else %}
          fetchOverlays: true,
          {% endif %}
          autoSaveMapType: true,
          {% if panel %}
          autoSaveLocation: true,
          {% endif %}
          {% if type == 'view' %}
          displayClosePanel: true,
          {% endif %}
          googleMapOptions: {
            zoom: {{ zoom }},
            maxZoom: null,
            disableDefaultUI: false,
            streetViewControl: false,
            scaleControl: true,
            panControlOptions: {position: google.maps.ControlPosition.RIGHT_TOP},
            zoomControlOptions: {position: google.maps.ControlPosition.RIGHT_TOP},
            scaleControlOptions: {position: google.maps.ControlPosition.RIGHT_BOTTOM,
                                  style: google.maps.ScaleControlStyle.DEFAULT},
            mapTypeControlOptions: {
                mapTypeIds: [google.maps.MapTypeId.ROADMAP,
                             komoo.CLEAN_MAPTYPE_ID,
                             google.maps.MapTypeId.HYBRID]
            },
            mapTypeId: komoo.CLEAN_MAPTYPE_ID,
          }
        };
        {% else %}
        var mapOptions = {
          editable: false,
          enableInfoWindow: false,
          fetchOverlays: false,
          googleMapOptions: {
            zoom: {{ zoom }},
            maxZoom: 17,
            disableDefaultUI: true,
            scaleControl: false,
            mapTypeControlOptions: {
                mapTypeIds: [google.maps.MapTypeId.ROADMAP,
                             komoo.CLEAN_MAPTYPE_ID,
                             google.maps.MapTypeId.HYBRID]
            },
            mapTypeId: google.maps.MapTypeId.HYBRID
          }
        };
        {% endif %}

        // Initialize the komoo.map.
        {{ type }} = new komoo.Map(mapElem, mapOptions);

        {% if type == 'main' %}
        editor = main;
        {% endif %}
  {% endif %}

        // Fill the screen.
        function fixMapSize() {
          fixMapHeight();
          fixMapWidth();
          if (window.google) google.maps.event.trigger({{ type }}.googleMap, 'resize');
        }
        function fixMapHeight() {
          {% if height == '100%' %}
          var height = $('body').innerHeight() - $('#top').innerHeight() - $('.mootiro_bar').innerHeight() - 5;
          $('#' + mapCanvasId).height(height);
          $('#map-panel').height(height);
          {% endif %}
        }
        function fixMapWidth() {
          {% if width == '100%' %}
          var panelWidth = $('#map-panel').innerWidth();
          try {
            var panelLeft = $('#map-panel').position().left;
          } catch (err) {
            var panelLeft = 0;
          }
          //$('#' + mapCanvasId).width($('body').innerWidth() - panelWidth - panelLeft).css('margin-left', panelWidth + panelLeft);
          console.log(panelWidth + panelLeft);
          $('#' + mapCanvasId).css({marginLeft: panelWidth + panelLeft, width: 'auto'});
          {% endif %}
        }
        $(window).resize(fixMapSize);
        fixMapSize();

  {% if type != 'disabled' %}
        {{ type }}.loadGeoJSON(geojson, true);

        {% if editable and panel %}
        // Load the form when user click 'finish' button
        {{ type }}.event.bind('finish_click', function (e, overlayType) {
          $.ajaxSetup({ cache: true }); // makes scripts be cached
          var geojson = {{ type }}.getGeoJSON({newOnly: true, geometryCollection: true});
          if (geojson.geometries.length > 0) {
            if (window.community_slug) {
              var url = overlayType.formUrl.replace('community_slug', community_slug);
            } else {
              var url = overlayType.formUrl.replace('/community_slug', '');
            }
            var context = $('#dinamic-form');

            // Submit the created form.
            function onSubmit () {
              var serialized = $(this).serialize();
              $.ajax({
                url: url,
                cache: true,
                context: context,
                data: serialized,
                dataType: 'html',
                type: 'POST',
                success: function (data, textStatus, jqXHR) {
                  $(this).html(data);
                  $(this).show();
                  if (!$('form', $(this)).data('is_ajaxform')) {
                    $('form', $(this)).submit(onSubmit);
                  }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                  alert('ERRO!!!11!');
                }
              });
              return false;
            }

            $.ajax({
              url: url,
              cache: true,
              context: context,
              dataType: 'html',
              type: 'GET',
              success: function (data, textStatus, jqXHR) {
                $(this).html(data);
                if (!$('form', $(this)).data('is_ajaxform')) {
                  $('form', $(this)).submit(onSubmit);
                }
                $('#id_geometry').val(JSON.stringify(geojson));
                $(this).show();
                fixMapSize();
                $('#' + mapContainerId + ', #map-panel').slideUp(600);
              },
              error: function (jqXHR, textStatus, errorThrown) {
                alert('ERRO!!!11!');
              }
            });
          } else {
            alert('Algo n√£o deu certo!');
          }
        });

        $('#map-panel-add').append({{ type }}.addMenu.show());
        {% endif %}

      }
      {% if edit_button %}
      // Add the link to edit the geometry. Must have the editor.
      $('#map-edit-button').click(function () {
          $('#map-container-editor').show();
          $('#main-content').hide();
          // TODO: Save a overlay copy to revert edition on cancel click.
          if (!editor) {
            initialize_map_editor();
            editor.loadGeoJSON(geojson);
            editor.event.bind('cancel_click', function () {
              $('#map-container-editor, #map-panel').slideUp(600);
              $('#main-content').show();
              google.maps.event.trigger({{ type }}.googleMap, 'resize');
            });
            editor.event.bind('finish_click', function () {
              $('#map-container-editor, #map-panel').slideUp(600);
              $('#main-content').show();
              google.maps.event.trigger({{ type }}.googleMap, 'resize');
              var newGeojson = editor.getGeoJSON({currentOnly: true, geometryCollection: true});
              $('#id_geometry').val(JSON.stringify(newGeojson));
              {{ type }}.clear();
              var newGeojson_ = editor.getGeoJSON({currentOnly: true});
              {{ type }}.loadGeoJSON(newGeojson_);
            });
          }
          editor.googleMap.setZoom(editor.googleMap.getZoom()+1);
          editor.googleMap.setZoom(editor.googleMap.getZoom()-1)
          google.maps.event.trigger(editor.googleMap, 'resize');
          editor.editOverlay(editor.overlays[0]);
          setTimeout(function () { editor.setCurrentOverlay(editor.overlays[0]); }, 100);
      });
      {% endif %}
  {% endif %}
    }
  {% if type != 'disabled' %}
    // Initialize the map after page loading.
    {% if not lazy %}
    google.maps.event.addDomListener(window, 'load', initialize_map_{{ type }});
    {% endif %}
    {% if type == 'view' %}
    // Handle "see on map" links.
    google.maps.event.addDomListener(window, 'load', function () {
        $('.see-on-map').click(function () {
          $('#map-container-{{ type }}').show();
          $('#main-content').hide();
          // TODO: Save a overlay copy to revert edition on cancel click.
          if (!window.{{ type }}) {
            initialize_map_{{ type }}();
            map = {{ type }};
            {{ type }}.event.bind('close_click', function () {
              $('#map-container-{{ type }}, #map-panel').slideUp(600);
              $('#main-content').show();
            });
          }
          {{ type }}.googleMap.setZoom({{ type }}.googleMap.getZoom()+1);
          {{ type }}.googleMap.setZoom({{ type }}.googleMap.getZoom()-1);
          {{ type }}.centerOverlay({{ type }}.overlays[0]);
          google.maps.event.trigger({{ type }}.googleMap, 'resize');
          return false;
        });
      });
    {% endif %}
  {% else %}
    initialize_map_disabled();
  {% endif %}
  </script>
{% endblock %}
