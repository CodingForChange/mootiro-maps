{% block api_js %}
  <!-- Google Maps API javascript -->
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&libraries=drawing"></script>
  <script type="text/javascript" src="http://www.google.com/jsapi"></script>
  <script type="text/javascript" src="{{STATIC_URL}}/js/infobox_packed.js"></script>
  <script type="text/javascript" src="{{STATIC_URL}}/js/komoo_map.js"></script>
{% endblock %}
{% block html %}
  <!-- HTML map container -->
  <div id="map-container{% if editable %}-editor{% endif %}" style="overflow:hidden;">
    {% if editable and panel %}
      {% include "komoo_map/panel.html" %}
      <script type="text/javascript" src="{{STATIC_URL}}/js/map_filter.js"></script>
    {% endif %}
    <div id="map-canvas{% if editable %}-editor{% endif %}"
      style="
      {% if width %}width: {{ width }}; height: {{ height }};
      {% endif %}
      "
      class="komoo-map-googlemap">
    </div>
    <div style="clear: both;"></div>
    </div>
      {% if edit_button %}
      <div style="clear: both;"><a href="#" id="map-edit-button">Edit</a></div>
      {% endif %}
    {% if editable %}
    <div id="dinamic-form"></div>
      {% endif %}
{% endblock %}

{% block map_js %}
  <!-- Map creation script -->
  <script type="text/javascript">
    {% if editable %}
    var editor;
    {% endif %}
    function initialize_map{% if editable %}_editor{% endif %}() {
      var map;
      var mapCanvasId = "map-canvas{% if editable %}-editor{% endif %}";
      var mapContainerId = "map-container{% if editable %}-editor{% endif %}";

      var mapElem = document.getElementById(mapCanvasId);

      $('#dinamic-form').hide()
      {% if editable %}
      var mapOptions = {
        editable: true,
        autoSaveLocation: true,
        googleMapOptions: {
          zoom: {{ zoom }},
        }
      };
      {% else %}
      var mapOptions = {
        editable: false,
        enableInfoWindow: false,
        googleMapOptions: {
          zoom: {{ zoom }},
          disableDefaultUI: true,
          scaleControl: false
        }
      };
      {% endif %}

      map = new komoo.Map(mapElem, mapOptions);
      {% if editable %}
      editor = map;
      {% endif %}

      function fixMapSize() {
        {% if height == '100%' %}
        var height = $('body').innerHeight() - $('#top').innerHeight() - $('.mootiro_bar').innerHeight() - 3;
        $('#' + mapCanvasId).height(height);
        $('#map-panel').height(height);
        {% endif %}
        {% if width == '100%' %}
        var panelWidth = $('#map-panel').innerWidth();
        $('#' + mapCanvasId).width($('body').innerWidth() - panelWidth).css('margin-left', panelWidth);
        {% endif %}
        google.maps.event.trigger(map.googleMap, 'resize');
      }
      $(window).resize(fixMapSize);
      fixMapSize();
      var geojson = JSON.parse('{{ geojson|safe }}');
      map.loadGeoJSON(geojson, true);

      {% if editable and panel %}
      // Load the form when user click 'finish' button
      map.event.bind('finish_click', function (e, overlayType) {
        var geojson = map.getGeoJSON({newOnly: true, geometryCollection: true});
        if (geojson.geometries.length > 0) {
          if (window.community_slug) {
            var url = overlayType.formUrl.replace('community_slug', community_slug);
          } else {
            var url = overlayType.formUrl.replace('/community_slug', '');
          }
          var context = $('#dinamic-form');

          function onSubmit () {
            var serialized = $(this).serialize();
            $.ajax({
              url: url,
              context: context,
              data: serialized,
              dataType: 'html',
              type: 'POST',
              success: function (data, textStatus, jqXHR) {
                $(this).html(data);
                $(this).show();
                $('form', $(this)).submit(onSubmit);
              },
              error: function (jqXHR, textStatus, errorThrown) {
                alert('ERRO!!!11!');
              }
            });
            return false;
          }

          $.ajax({
            url: url,
            context: context,
            dataType: 'html',
            type: 'GET',
            success: function (data, textStatus, jqXHR) {
              $(this).html(data);
              $('form', $(this)).submit(onSubmit);
              $('#id_geometry').val(JSON.stringify(geojson));
              $(this).show();
              fixMapSize();
              $('#' + mapcontainerId + ', #map-panel').slideUp(600);
            },
            error: function (jqXHR, textStatus, errorThrown) {
              alert('ERRO!!!11!');
            }
          });
        } else {
          alert('Algo n√£o deu certo!');
        }
      });
      {% endif %}

      {% if editable %}
      // Connect the search input box
      $('#search').submit(function () {
        var query = $('#search-bar').val();
        map.goTo(query);
        return false;
      });
      {% endif %}
      {% if edit_button %}
      $('#map-edit-button').click(function () {
          $('#map-container-editor').show();
          if (!editor) {
            initialize_map_editor();
            editor.event.bind('cancel_click', function () {
              console.log('haaaaaaa');
              $('#map-container-editor, #map-panel').slideUp(600);
            });
            editor.event.bind('finish_click', function () {
              $('#map-container-editor, #map-panel').slideUp(600);
              var newGeojson = editor.getGeoJSON({currentOnly: true, geometryCollection: true});
              $('#id_geometry').val(JSON.stringify(newGeojson));
            });
          }
          editor.clear();
          editor.loadGeoJSON(geojson);
          editor.googleMap.setZoom(editor.googleMap.getZoom()+1);
          editor.googleMap.setZoom(editor.googleMap.getZoom()-1)
          google.maps.event.trigger(editor, 'resize');
          editor.editOverlay(editor.overlays[0]);
          setTimeout(function () { editor.setCurrentOverlay(editor.overlays[0]); }, 100);
      });
      {% endif %}
    }
    // initialize the map after page loading
    {% if not lazy %}
    google.maps.event.addDomListener(window, 'load', initialize_map{% if editable %}_editor{% endif %});
    {% endif %}
  </script>
{% endblock %}
