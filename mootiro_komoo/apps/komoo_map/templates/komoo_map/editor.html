{% block api_js %}
  <!-- Google Maps API javascript -->
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&libraries=drawing"></script>
  <script type="text/javascript" src="http://www.google.com/jsapi"></script>
  <script type="text/javascript" src="{{STATIC_URL}}/js/infobox_packed.js"></script>
  <script type="text/javascript" src="{{STATIC_URL}}/js/komoo_map.js"></script>
{% endblock %}
{% block html %}
  <!-- HTML map container -->
  <div id="map-container" style="overflow:hidden;">
    {% if editable %}
    <div id="map-panel" style="width: 300px; position: absolute; overflow: auto;">
      <ul class="map-tabs" id="map-panel-tabs">
        <li class="map-tab" id="map-panel-layers-tab" style="width: 30%;"><a href="#map-panel-layers">Layers</a></li>
        <li class="map-tab" id="map-panel-filter-tab" style="width: 30%;"><a href="#map-panel-filter">Filter</a></li>
        <li class="map-tab" id="map-panel-add-tab" style="width: 30%;"><a href="#map-panel-add">Add</a></li>
      </ul>
      <div style="clear: both;"></div>
      <div class="panel" id="map-panel-layers">
      </div>
      <div class="panel" id="map-panel-filter">
      </div>
      <div class="panel" id="map-panel-add">
      </div>
      <div style="clear: both;"></div>
    </div>
    <script type="text/javascript">
      $(function() {
        tabs = new Tabs('.map-tab', '.panel');
      });
    </script>
    {% endif %}
    <div id="map-canvas"
      style="
      {% if width %}width: {{ width }}; height: {{ height }};
      {% endif %}
      "
      class="komoo-map-googlemap">
    </div>
    <div style="clear: both;"></div>
    </div>
    <div id="dinamic-form"></div>
{% endblock %}

{% block map_js %}
  <!-- Map creation script -->
  <script type="text/javascript">
    var map;
    function initialize_map() {
      var mapElem = document.getElementById("map-canvas");
      $('#dinamic-form').hide()
      {% block map_options_js %}
      {% if editable %}
      var mapOptions = {
        editable: true,
        autoSaveLocation: true,
        googleMapOptions: {
          zoom: {{ zoom }},
        }
      };
      {% else %}
      var mapOptions = {
        editable: false,
        enableInfoWindow: false,
        googleMapOptions: {
          zoom: {{ zoom }},
          disableDefaultUI: true,
          scaleControl: false
        }
      };
      {% endif %}
      {% endblock %}

      map = new komoo.Map(mapElem, mapOptions);

      {% block extra_js %}
      var geojson = JSON.parse('{{ geojson|safe }}');
      map.loadGeoJSON(geojson, true, false);

      function fixMapSize() {
        {% if height == '100%' %}
        var height = $('body').innerHeight() - $('#top').innerHeight() - $('.mootiro_bar').innerHeight() - 3;
        $('#map-canvas').height(height);
        $('#map-panel').height(height);
        {% endif %}
        {% if width == '100%' %}
        var panelWidth = $('#map-panel').innerWidth();
        $('#map-canvas').width($('body').innerWidth() - panelWidth).css('margin-left', panelWidth);
        {% endif %}
        google.maps.event.trigger(map.googleMap, 'resize');
      }
      $(window).resize(fixMapSize);
      fixMapSize();

      {% if editable %}
      $('#map-panel-add').append(map.addMenu.show());
      if ('{{input_id}}') {
        map.event.bind('changed', function () {
          var geojson = JSON.stringify(map.getGeoJSON());
          $('#{{input_id}}').val(geojson);
        });
      }
      // Load the form when user click 'finish' button
      map.event.bind('finish_click', function (e, overlayType) {
        console.log(overlayType);
        var geojson = map.getGeoJSON({newOnly: true, geometryCollection: true});
        if (geojson.geometries.length > 0) {
          if (window.community_slug) {
            var url = overlayType.formUrl.replace('community_slug', community_slug);
          } else {
            var url = overlayType.formUrl.replace('/community_slug', '');
          }
          var context = $('#dinamic-form');

          function onSubmit () {
            var serialized = $(this).serialize();
            $.ajax({
              url: url,
              context: context,
              data: serialized,
              dataType: 'html',
              type: 'POST',
              success: function (data, textStatus, jqXHR) {
                $(this).html(data);
                $(this).show();
                $('form', $(this)).submit(onSubmit);
              },
              error: function (jqXHR, textStatus, errorThrown) {
                alert('ERRO!!!11!');
              }
            });
            return false;
          }

          $.ajax({
            url: url,
            context: context,
            dataType: 'html',
            type: 'GET',
            success: function (data, textStatus, jqXHR) {
              $(this).html(data);
              $('form', $(this)).submit(onSubmit);
              $('#id_geometry').val(JSON.stringify(geojson));
              $(this).show();
              fixMapSize();
              $('#map-container, #map-panel').slideUp(600);
            },
            error: function (jqXHR, textStatus, errorThrown) {
              alert('ERRO!!!11!');
            }
          });

          $('#map-form').submit(onSubmit);
        } else {
          alert('Algo n√£o deu certo!');
        }
      });

      // Connect the search input box
      $('#search').submit(function () {
        var query = $('#search-bar').val();
        map.goTo(query);
        return false;
      });
      {% endif %}
      {% endblock %}
    }
    {% block map_loading_js %}
    // initialize the map after page loading
    google.maps.event.addDomListener(window, 'load', initialize_map);
    {% endblock %}
  </script>
{% endblock %}
