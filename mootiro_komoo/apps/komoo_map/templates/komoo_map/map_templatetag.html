{% load i18n %}
{% block api_js %}
{% endblock %}
{% include "main/supporters.html" %}
{% block html %}
  <!-- HTML map container -->
  <div id="map-container-{{ type }}" class="{% if panel %}with-panel{% endif %}" style="height: 100%;">
    {% if panel %} {% include panel %} {% endif %}
    <div id="map-canvas-{{ type }}" style="{% if width %}width: {{ width }};{% endif %} {% if height %}height: {{ height }};{% endif %}" class="komoo-map-googlemap">
      {% if type == 'disabled' %} MAP DISABLED {% endif %}
    </div>
    <div style="clear: both;"></div>
  </div>
    {% if edit_button %}<div><a style="width:91%; margin-top:5px;" href="#" class="button" id="map-edit-button">{% trans "Open the map editor" %}</a></div>{% endif %}
  {% if editable %}<div id="dinamic-form"></div>{% endif %}
{% endblock %}

{% block map_js %}
  <!-- Map creation script -->
  {% if type != 'disabled' %}
  <script type="text/javascript">
    var geojson = {{ geojson|safe }};
    var featureTypes = {{ feature_types_json|safe }};

    initialize_map_{{ type }} = function () {
      $('#dinamic-form').hide();

      /** Creating the map object **/
      {{ type }} = komoo.maps.makeMap({
        type: '{{ type }}',
        featureTypes: featureTypes,
        geojson: geojson,
        elementId: "map-canvas-{{ type }}",
      });
      if (!{{ type }}.goToSavedLocation()) {
        {{ type }}.goToUserLocation();
      }
      {% if editable %}
        editor = {{ type }};
      {% endif %}

      {% if height == '100%' or width == '100%' %}
        /** The map should fill the main page size **/
        function fixMapSize(e) {
          fixMapHeight(e.data.map);
          fixMapWidth(e.data.map);
          if (window.google) google.maps.event.trigger(e.data.map.googleMap, 'resize');
        }
        function fixMapHeight(map, opt_mapPanel) {
          var mapPanel = opt_mapPanel || $('#map-panel');
          var height = $('body').innerHeight() - $('#top').innerHeight() - $('.mootiro_bar').innerHeight() - 5;
          $(map.element).height(height);
          mapPanel.height(height);
          $('.panel', mapPanel).height(height - (window.community_slug ? 170 : 146));
        }
        function fixMapWidth(map, opt_mapPanel) {
          var mapPanel = opt_mapPanel || $('#map-panel');
          var panelWidth = mapPanel.innerWidth();
          try {
            var panelLeft = mapPanel.position().left;
          } catch (err) {
            var panelLeft = 0;
          }

          $(map.element).css({marginLeft: panelWidth + panelLeft, width: 'auto'});
        }
        $(window).resize({map: editor}, fixMapSize);
        $(window).resize()
      {% endif %}

      $("#map-panel").show();

      {% if editable %}
        komoo.event.addListener(editor, 'drawing_finished', function (feature, gotoNextStep) {
          if (!feature.isNew()) return;
          var featureType, url, geojson;
          var context = $('#dinamic-form');
          $.ajaxSetup({ cache: true });

          if (gotoNextStep && feature) {
            featureType = feature.getFeatureType();
            geojson = feature.getGeometryCollectionGeoJson();
            url = featureType.formUrl.replace('/communitySlug', (window.community_slug) ? ('/' + community_slug) : '');
            $.ajax({
              url: url,
              cache: true,
              context: context,
              dataType: 'html',
              type: 'GET',
              success: function (data, textStatus, jqXHR) {
                $(this).html(data);
                $('#id_geometry').val(JSON.stringify(geojson));
                $(this).show();
                $(window).resize()
                $('#map-container-{{ type }}, #map-panel').slideUp(600);
              },
              error: function (jqXHR, textStatus, errorThrown) {
                alert('ERRO!!!11!');
              }
            });
          }
        });
      {% endif %}

      {% if edit_button %}
        /* Add the link to edit the geometry. Must have the editor. */
        $('#map-edit-button').click(function () {
            $('#main-content').hide();
            if (!window.editor) {
              window.editor = initialize_map_editor();
              window.editor.loadGeoJSON(geojson, true);

              komoo.event.addListener(editor, 'drawing_finished', function (feature, gotoNextStep) {
                if (gotoNextStep) {
                  $('#id_geometry').val(JSON.stringify(feature.getGeometryCollectionGeoJson()));
                  if (window.{{ type }}) {
                    {{ type }}.clear();
                    {{ type }}.loadGeoJson(editor.getGeoJson());
                  }
                } else {
                }
                $('#map-container-editor, #map-panel').slideUp(600);
                $('#main-content').show();
                if (window.{{ type }}) google.maps.event.trigger({{ type }}.googleMap, 'resize');

              });
            }

            window.editor.editFeature();
            $('#map-container-editor, #map-panel').show();
            google.maps.event.trigger(window.editor.googleMap, 'resize');
        });
      {% endif %}

      {% if type == 'view' %}
        $('.see-on-map').click(function () {
          $('#map-container-{{ type }}').show();
          $('#main-content').hide();
          if (!window.{{ type }}) {
            var map = initialize_map_{{ type }}();
            komoo.event.addListener(map, 'close_click', function () {
              $('#map-container-{{ type }}, #map-panel').slideUp(600);
              $('#main-content').show();
            });
          }
          {{ type }}.centerFeature();
          google.maps.event.trigger({{ type }}.googleMap, 'resize');
          return false;
        });
      {% endif %}

      return {{ type }};
    };

{% if not lazy %}
  require(['map/maps'], initialize_map_{{ type }});
{% endif %}

  </script>
  {% endif %}
{% endblock %}
