{% load i18n %}
{% block api_js %}
  <!-- Google Maps API javascript -->
  {% if type != 'disabled' %}
  <script type="text/javascript">
    if (!window.google || !window.google.maps) {
      document.write("<s" + "cript type=\"text/javascript\" src=\"http://maps.google.com/maps/api/js?sensor=false&libraries=drawing&language={{ LANGUAGE_CODE }}\" " + "><" + "/script>");
      document.write("<s" + "cript type=\"text/javascript\" src=\"http://www.google.com/jsapi\"" + "><" + "/script>");
    }
    if (!window.komoo) {
      document.write("<s" + "cript type=\"text/javascript\" src=\"{{ STATIC_URL }}js/map/compat.js\" defer=\"defer\"" + "><" + "/script>");
      document.write("<s" + "cript type=\"text/javascript\" src=\"{{ STATIC_URL }}js/map/utils.js\" defer=\"defer\"" + "><" + "/script>");
      document.write("<s" + "cript type=\"text/javascript\" src=\"{{ STATIC_URL }}js/vendor/infobox_packed.js\" defer=\"defer\"" + "><" + "/script>");
      document.write("<s" + "cript type=\"text/javascript\" src=\"{{ STATIC_URL }}js/vendor/markerclusterer_packed.js\" defer=\"defer\"" + "><" + "/script>");
      document.write("<s" + "cript type=\"text/javascript\" src=\"{{ STATIC_URL }}js/map/multimarker.js\" defer=\"defer\"" + "><" + "/script>");
      document.write("<s" + "cript type=\"text/javascript\" src=\"{{ STATIC_URL }}js/map/multipolyline.js\" defer=\"defer\"" + "><" + "/script>");
      document.write("<s" + "cript type=\"text/javascript\" src=\"{{ STATIC_URL }}js/map/geometries.js\" defer=\"defer\"" + "><" + "/script>");
      document.write("<s" + "cript type=\"text/javascript\" src=\"{{ STATIC_URL }}js/map/features.js\" defer=\"defer\"" + "><" + "/script>");
      document.write("<s" + "cript type=\"text/javascript\" src=\"{{ STATIC_URL }}js/map/collections.js\" defer=\"defer\"" + "><" + "/script>");
      document.write("<s" + "cript type=\"text/javascript\" src=\"{{ STATIC_URL }}js/map/controls.js\" defer=\"defer\"" + "><" + "/script>");
      document.write("<s" + "cript type=\"text/javascript\" src=\"{{ STATIC_URL }}js/map/providers.js\" defer=\"defer\"" + "><" + "/script>");
      document.write("<s" + "cript type=\"text/javascript\" src=\"{{ STATIC_URL }}js/map/maptypes.js\" defer=\"defer\"" + "><" + "/script>");
      document.write("<s" + "cript type=\"text/javascript\" src=\"{{ STATIC_URL }}js/map/maps.js\" defer=\"defer\"" + "><" + "/script>");
    }
  </script>
  {% endif %}
{% endblock %}
{% include "main/supporters.html" %}
{% block html %}
  <!-- HTML map container -->
  <div id="map-container-{{ type }}" class="{% if panel %}with-panel{% endif %}" style="height: 100%;">
    {% if panel %}
      {% include "komoo_map/panel.html" %}
      <script type="text/javascript" src="{{STATIC_URL}}/js/map_filter.js"></script>
    {% endif %}
    <div id="map-canvas-{{ type }}"
      style="{% if width %}width: {{ width }}; height: {{ height }};{% endif %}"
      class="komoo-map-googlemap">
        {% if type == 'disabled' %} MAP DISABLED {% endif %}
    </div>
    <div style="clear: both;"></div>
  </div>
  <div id="dinamic-form"></div>
{% endblock %}

{% block map_js %}
  <!-- Map creation script -->
  <script type="text/javascript">
    var geojson = {{ geojson|safe }};
    var featureTypes = {{ feature_types_json|safe }};

    initialize = function () {

      $('#dinamic-form').hide();

      /** The map should fill the main page size **/
      function fixMapSize() {
        fixMapHeight();
        fixMapWidth();
        if (window.google) google.maps.event.trigger({{ type }}.googleMap, 'resize');
      }
      function fixMapHeight() {
        {% if height == '100%' %}
          var mapPanel = $('#map-panel');
          var height = $('body').innerHeight() - $('#top').innerHeight() - $('.mootiro_bar').innerHeight() - 5;
          $("#map-canvas-{{ type }}").height(height);
          mapPanel.height(height);
          $('.panel', mapPanel).height(height - (window.community_slug ? 170 : 146));
        {% endif %}
      }
      function fixMapWidth() {
        {% if width == '100%' %}
          var panelWidth = $('#map-panel').innerWidth();
          try {
            var panelLeft = $('#map-panel').position().left;
          } catch (err) {
            var panelLeft = 0;
          }
          $("#map-canvas-{{ type }}").css({marginLeft: panelWidth + panelLeft, width: 'auto'});
        {% endif %}
      }
      $(window).resize(fixMapSize);

      /** Creating the map object **/
      {{ type }} = komoo.maps.make{{ type|title }}({
        featureTypes: featureTypes,
        geojson: geojson,
        elementId: "map-canvas-{{ type }}",
      });
      editor = {{ type }}

      komoo.event.addListener(editor, 'drawing_finished', function (feature, gotoNextStep) {
        var featureType, url, geojson;
        var context = $('#dinamic-form');
        $.ajaxSetup({ cache: true });

        if (gotoNextStep && feature) {
          featureType = feature.getFeatureType();
          geojson = feature.getGeometryCollectionGeoJson();
          url = featureType.formUrl.replace('/communitySlug', (window.community_slug) ? ('/' + community_slug) : '');
          $.ajax({
            url: url,
            cache: true,
            context: context,
            dataType: 'html',
            type: 'GET',
            success: function (data, textStatus, jqXHR) {
              $(this).html(data);
              $('#id_geometry').val(JSON.stringify(geojson));
              $(this).show();
              fixMapSize();
              $('#map-container-{{ type }}, #map-panel').slideUp(600);
            },
            error: function (jqXHR, textStatus, errorThrown) {
              alert('ERRO!!!11!');
            }
          });
        }
      });

      fixMapSize();

      $("#map-panel").show();
    };
    {% if not lazy %} google.maps.event.addDomListener(window, 'load', initialize); {% endif %}



  </script>
{% endblock %}
