<html>
  <head>
    <script src="http://maps.google.com/maps/api/js?sensor=false&libraries=drawing&language=pt-br"></script>
    <script type="text/javascript" src="/static/js/config.js"></script>
    <script type="text/javascript" data-main="app" src="/static/lib/require.js"></script>
    <link rel="stylesheet" href="/static/lib/qunit/qunit.css" type="text/css" media="screen" />
    <script type="text/javascript" src="/static/lib/qunit/qunit.js"></script>

    <script type="text/javascript">
      require(['map/geometries'], function (geometries) {

        test('Basic requirements', function () {
          expect(3);
          ok(Function.call, 'Function.call()');
          ok(Object.create, 'Object.create()');
          ok(google.maps, 'Google maps API');
        });

        test('Get geometry default properties', function () {
          expect(6);
          var simpleGeometry = new geometries.Polygon();
          equal(simpleGeometry.getBackgroundColor(),
              geometries.defaults.BACKGROUND_COLOR,
              'Should return the default background color');
          equal(simpleGeometry.getBackgroundOpacity(),
              geometries.defaults.BACKGROUND_OPACITY,
              'Should return the default background opacity');
          equal(simpleGeometry.getBorderColor(),
              geometries.defaults.BORDER_COLOR,
              'Should return the default border color');
          equal(simpleGeometry.getBorderOpacity(),
              geometries.defaults.BORDER_OPACITY,
              'Should return the default border opacity');
          equal(simpleGeometry.getBorderSize(),
              geometries.defaults.BORDER_SIZE,
              'Should return the default border size');
          equal(simpleGeometry.getDefaultZIndex(),
              geometries.defaults.ZINDEX,
              'Should return the default z-index');
        });

        test('Get geometry properties from "feature"', function () {
          expect(6);
          var simpleGeometry = new geometries.Polygon();
          var fakeFeature = {
            getBackgroundColor: function () { return '#fff'; },
            getBackgroundOpacity: function () { return 0.5; },
            getBorderColor: function () { return '#ccc'; },
            getBorderOpacity: function () { return 0.8; },
            getBorderSize: function () { return 10; },
            getDefaultZIndex: function () { return 100; }
          };
          simpleGeometry.setFeature(fakeFeature);

          equal(simpleGeometry.getBackgroundColor(), '#fff',
              'Should return the background color from feature');
          equal(simpleGeometry.getBackgroundOpacity(), 0.5,
              'Should return the background opacity from feature');
          equal(simpleGeometry.getBorderColor(), '#ccc',
              'Should return the border color from feature');
          equal(simpleGeometry.getBorderOpacity(), 0.8,
              'Should return the border opacity from feature');
          equal(simpleGeometry.getBorderSize(), 10,
              'Should return the border size from feature');
          equal(simpleGeometry.getDefaultZIndex(), 100,
              'Should return the z-index from feature');
        });

        test('Create point geometry with googles marker object', function () {
          expect(3);
          var simplePoint = new geometries.Point();
          ok(simplePoint.overlay, 'Should create googleObject');
          ok(geometries.MultiMarker.prototype.isPrototypeOf(
                simplePoint.overlay),
              'object should be a google.maps.Marker object')
          equal(simplePoint.getGeometryType(), 'Point',
              'Geometry type should be "Point"');
        });

        test('Create polyline geometry with googles polyline object', function () {
          expect(3);
          var simplePolyline = new geometries.LineString();
          ok(simplePolyline.overlay, 'Should create googleObject');
          ok(google.maps.Polyline.prototype.isPrototypeOf(
                simplePolyline.overlay),
              'object should be a google.maps.Polyline object');
          equal(simplePolyline.getGeometryType(), 'LineString',
              'Geometry type should be "LineString"');
        });

        test('Create polygon geometry with googles polygon object', function () {
          expect(3);
          var simplePolygon = new geometries.Polygon();
          ok(simplePolygon.overlay, 'Should create googleObject');
          ok(google.maps.Polygon.prototype.isPrototypeOf(
                simplePolygon.overlay),
              'object should be a google.maps.Polygon object');
          equal(simplePolygon.getGeometryType(), 'Polygon',
              'Geometry type should be "Polygon"');
        });

        test('Create multipoint geometry with MultiMarker object', function () {
          expect(3);
          var simpleMultiPoint = new geometries.MultiPoint();
          ok(simpleMultiPoint.overlay, 'Should create googleObject');
          ok(MultiMarker.prototype.isPrototypeOf(simpleMultiPoint.overlay),
              'object should be a MultiMarker object');
          equal(simpleMultiPoint.getGeometryType(), 'MultiPoint',
              'Geometry type should be "MultiPoint"');
        });

        test('Set coordinates to point geometry', function () {
          expect(2);
          var point = new geometries.Point();
          var coordinates = [0, 1];
          point.setCoordinates(coordinates);
          var position = point.overlay.getPosition();
          equal(position.lat(), coordinates[0]);
          equal(position.lng(), coordinates[1]);
        });

        test('Get coordinates from point geometry', function () {
          expect(1);
          var point = new geometries.Point();
          var coordinates = [[1, 2]];
          point.setCoordinates(coordinates);
          deepEqual(point.getCoordinates(), coordinates,
              'Should return the same coordinates it received');
        });

        test('Get coordinates from empty point geometry', function () {
          expect(1);
          var point = new geometries.Point();
          deepEqual(point.getCoordinates(), [],
              'Should return null');
        });


        test('Set coordinates to polyline geometry', function () {
          expect(10);
          var polyline = new geometries.LineString();
          var coordinates = [[0, 0], [0, 1], [1, 1], [1, 0], [1, 2]];
          polyline.setCoordinates(coordinates);
          var googlePath = polyline.overlay.getPath();
          googlePath.forEach(function(pos, i) {
            equal(pos.lat(), coordinates[i][0]);
            equal(pos.lng(), coordinates[i][1]);
          });
        });

        test('Get coordinates from polyline geometry', function () {
          expect(1);
          var polyline = new geometries.LineString();
          var coordinates = [[0, 0], [0, 1], [1, 1], [1, 0], [1, 2]];
          polyline.setCoordinates(coordinates);
          deepEqual(polyline.getCoordinates(), coordinates,
              'Should return the same coordinates it received');
        });

        test('Get coordinates from empty polyline geometry', function () {
          expect(1);
          var polyline = new geometries.LineString();
          deepEqual(polyline.getCoordinates(), [],
              'Should return an empty array');
        });

        test('Set coordinates to polygon geometry', function () {
          expect(16);
          var polygon = new geometries.Polygon();
          var coordinates = [
            [[0, 0], [0, 1], [1, 1], [1, 0], [0, 0]],
            [[2, 2], [2, 3], [3, 3], [3, 2], [2, 2]]];
          polygon.setCoordinates(coordinates);
          var googlePaths = polygon.overlay.getPaths();
          googlePaths.forEach(function (path, i) {
            path.forEach(function(pos, j) {
              equal(pos.lat(), coordinates[i][j][0]);
              equal(pos.lng(), coordinates[i][j][1]);
            });
          });
        });

        test('Get coordinates from polygon geometry', function () {
          expect(1);
          var polygon = new geometries.Polygon();
          var coordinates = [
            [[0, 0], [0, 1], [1, 1], [1, 0], [0, 0]],
            [[2, 2], [2, 3], [3, 3], [3, 2], [2, 2]]];
          polygon.setCoordinates(coordinates);
          deepEqual(polygon.getCoordinates(), coordinates,
              'Should return the same coordinates it received');
        });

        test('Get coordinates from empty polygon geometry', function () {
          expect(1);
          var polygon = new geometries.Polygon();
          deepEqual(polygon.getCoordinates(), [],
              'Should return an empty array');
        });

        test('Set coordinates to multpoint geometry', function () {
          expect(4);
          var multiPoint = new geometries.MultiPoint();
          var coordinates = [[0,1], [3,4]];
          multiPoint.setCoordinates(coordinates);
          var positions = multiPoint.getPositions();
          equal(positions[0].lat(), coordinates[0][0]);
          equal(positions[0].lng(), coordinates[0][1]);
          equal(positions[1].lat(), coordinates[1][0]);
          equal(positions[1].lng(), coordinates[1][1]);
        });

        test('Get coordinates from multipoint geometry', function () {
          expect(1);
          var multiPoint = new geometries.MultiPoint();
          var coordinates = [[0, 1], [3, 4]];
          multiPoint.setCoordinates(coordinates);
          deepEqual(multiPoint.getCoordinates(), coordinates,
              'Should return the same coordinates it received');
        });

        test('Get coordinates from empty multipoint geometry', function () {
          expect(1);
          var multiPoint = new geometries.MultiPoint();
          deepEqual(multiPoint.getCoordinates(), [],
              'Should return an empty array');
        });

        test('Geometry factory', function () {
          expect(3);
          var pointFeature = {
            'type': 'Feature',
            'geometry': {
              'type': 'Point',
              'coordinates': [1, 2]
            },
            'properties': null
          };
          var point = geometries.makeGeometry(pointFeature);
          ok(point instanceof geometries.MultiPoint,
              'Geometry object shoud be an instance of geometries.MultiPoint');

          var polylineFeature = {
            'type': 'Feature',
            'geometry': {
              'type': 'LineString',
              'coordinates': [[0, 0], [1, 1], [1, 2]]
            },
            'properties': null
          };
          var polyline = geometries.makeGeometry(polylineFeature);
          ok(polyline instanceof geometries.MultiLineString,
              'Geometry object shoud be an instance of geometries.MultiLineString');

          var polygonFeature = {
            'type': 'Feature',
            'geometry': {
              'type': 'Polygon',
              'coordinates': [[[0, 0], [1, 1], [1, 2], [0, 0]]]
            },
            'properties': null
          };
          var polygon = geometries.makeGeometry(polygonFeature);
          ok(polygon instanceof geometries.Polygon,
              'Geometry object shoud be an instance of geometries.Polygon');
        });

      });
    </script>

  </head>
  <body>
    <h1 id="qunit-header">komoo.geometries</h1>
    <h2 id="qunit-banner"></h2>
    <div id="qunit-testrunner-toolbar"></div>
    <h2 id="qunit-userAgent"></h2>
    <ol id="qunit-tests"></ol>
    <div id="qunit-fixture">test markup, will be hidden</div>
  </body>
</html>
