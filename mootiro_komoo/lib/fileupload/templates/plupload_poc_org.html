<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <title>fileupload</title>

         <!-- Load Queue widget CSS and jQuery -->
        <style type="text/css">
            @import url(/static/plupload/js/jquery.plupload.queue/css/jquery.plupload.queue.css);
            label{
                display: block;
            }
            input[type=text]{
                width: 314px;
            }
            .plupload_header_content{
                background: none;
                min-height: 36px;
            }
            .plupload_container{
                width: 500px;
            }
            .file-entry{
                background-color: #cccccc;
                border-radius: 5px;
                padding: 20px;
                font-weight: bold;
                vertical-align: middle;
                color: #555555;
                margin: 10px;
                width: 460px;
            }
            .file-img{
                width: 54px;
                height: 40px;
                padding-right: 30px;
                vertical-align: middle;
            }
            .file-delete{
                font-weight: bolder;
                float: right;
                vertical-align: top;
                color: #777777;
            }
        </style>

    </head>
    <body>
        <form method="post" action="/upload/poc/form/">
            {% csrf_token %}

            {% for field in form %}
                <div>
                    {% if not is_hidden %}<div>{{ field.label }}</div> {% endif %}
                    {{ field }}
                </div>
            {% endfor %}
            <div id="uploader">
                <p>You browser doesn't have Flash, Silverlight, Gears, BrowserPlus or HTML5 support.</p>
            </div>

            <div id="files-list"></div>
            <input type="submit" value="send">
        </form>

    <script type="text/javascript" src="{{STATIC_URL}}lib/jquery-1.7.1.js"></script>
    <!-- Third party script for BrowserPlus runtime (Google Gears included in Gears runtime now) -->
        <script type="text/javascript" src="http://bp.yahooapis.com/2.4.21/browserplus-min.js"></script>

        <!-- Load plupload and all it's runtimes and finally the jQuery queue widget -->
        <script type="text/javascript" src="/static/plupload/js/plupload.full.js"></script>
        <script type="text/javascript" src="/static/plupload/js/jquery.plupload.queue/jquery.plupload.queue.js"></script>

        <script type="text/javascript">
        // Convert divs to queue widgets when the DOM is ready
        $(function() {

            window.get_files_list = function(){
                var ids_list = '';
                $('#files-list .file-entry:visible').each(function(idx, obj){
                    ids_list += $(this).attr('file-id') + '|';
                });
                return ids_list;
            };

            var on_add_file = function(file){
                $('#files-list').append('' +
                    '<div class="file-entry" file-id="' + file.id + '">' +
                        '<img class="file-img" src="' + file.url + '">' +
                         file.name +
                         '<span class="file-delete" delete-url="'+ file.delete_url +'">x</span>' +
                    '</div>'
                );
            };

            $('.file-delete').live('click', function(){
                var delete_url = $(this).attr('delete-url');
                $.post(
                    delete_url,
                    {csrfmiddlewaretoken: '{{ csrf_token }}'},
                    function(data){
                        console.log(data);
                    },
                    'json');

                $(this).parent().fadeOut()
            });


            $("#uploader").pluploadQueue({
                // General settings
                runtimes : 'html5,flash,gears,silverlight,browserplus',
                url : '{% url upload-new %}',
                max_file_size : '10mb',
                chunk_size : '1mb',
                unique_names : true,

                // Resize images on clientside if we can
                resize : {width : 320, height : 240, quality : 90},

                // Specify what files to browse for
                filters : [
                    {title : "Image files", extensions : "jpg,gif,png"},
                    {title : "Zip files", extensions : "zip"}
                ],

                // Flash settings
                flash_swf_url : '/static/plupload/js/plupload.flash.swf',

                // Silverlight settings
                silverlight_xap_url : '/static/plupload/js/plupload.silverlight.xap',

                multiple_queues: true,
                // multi_selection:false,
                max_file_count: 5,

                drop_element: 'uploader',
                sortable: true,

                multipart_params : {
                    "csrfmiddlewaretoken" : "{{ csrf_token }}"
                },


                preinit: {
                    'Init' : function(){
                        $('.plupload_header_title').text('Upload de Arquivos');
                        $('.plupload_header_text').text('');
                        $('.plupload_buttons .plupload_add').text('Adicionar Arquivos');
                        $('.plupload_buttons .plupload_start').text('Iniciar Upload');
                    },
                    FilesAdded: function(up, files) {
                        var max = up.settings.max_file_count;
                        if ((up.files.length + files.length) > max){
                            alert('Max number of files: ' + max);
                        }
                    },
                    QueueChanged: function(up){
                        if (up.files.length > up.settings.max_file_count){
                            while(up.files.length > up.settings.max_file_count){
                                up.removeFile(up.files[up.settings.max_file_count])
                            }
                        }
                    },
                    FileUploaded: function(up, file, response) {
                        var resp = JSON.parse(response.response);
                        on_add_file(resp);
                    }
                }

            });

            // Client side form validation
            $('form').submit(function(e) {
                var uploader = $('#uploader').pluploadQueue();
                $('#id_files_list').val(get_files_list());

                // Files in queue upload them first
                if (uploader.files.length > 0) {
                    // When all files are uploaded submit form
                    uploader.bind('StateChanged', function() {
                        if (uploader.files.length === (uploader.total.uploaded + uploader.total.failed)) {
                            $('form')[0].submit();
                        }
                    });

                    uploader.start();
                } else {
                    alert('You must queue at least one file.');
                }
                return false;
            });
        });
        </script>

    </body>
</html>
