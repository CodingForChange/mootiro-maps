{% extends "global.html" %}
{% load i18n %}
{% load komoo_filters %}
{% load komoo_tags %}
{% load komoo_map_tags %}
{% load update_tags %}
{% load comment_tags %}
{% load humanize %}


{% block content %}
{% komoo_map_tooltip %}
  <div id="updates-header">
    <img alt="" src="{{STATIC_URL}}img/updates-page/novidades.png"/>
  </div>

  <div id="main-content">
    <div class="main-column content-updates">
      {% updates_list updates_page %}
    </div>

    <div class="right-bar news-updates shadow-container">
      <h2><img src="{{STATIC_URL}}img/updates-page/news.png"/>{% trans "News" %}</h2>
      <div>
        {% for n in news %}
          <p>
            {% if n.title %}
            <h4>
              {% if n.title_link %}
                <a href="{{ n.title_link }}">{{ n.title }}</a>
              {% else %}
                {{ n.title }}
              {% endif %}
            </h4>
            {% endif %}
            {{ n.description }}<br/>
            <span class="attenuate">{{ n.date|date:"d/m/Y" }}</span>
          </p>
        {% endfor %}
      </div>
    </div>
  </div>

{% endblock %}

{% block page_scripts %}
    <script type="text/javascript">

        $(function(){
            var tabs = new Tabs('.content-updates .tab', '.content-updates .panel',
                          undefined, 'active');


            var closed_panel_width = $("#about-mootiro.closed").width();
            var closed_panel_height = $("#about-mootiro.closed").height();
            var close_panel;

            $("#about-mootiro.closed").live("mouseenter", function (evt) {
                $(this).toggleClass("closed open");
                $(this).animate({
                    width: closed_panel_width + 105,
                    height: closed_panel_height + 155
                });
                $("#about-mootiro .about-image, #about-mootiro .about-content").toggle();
            });

            $("#about-mootiro.open").live("mouseleave", function (evt) {
                var about_mootiro = $(this);
                close_panel = setTimeout(function(){
                  about_mootiro.toggleClass("closed open");
                  $("#about-mootiro .about-image, #about-mootiro .about-content").toggle();
                  about_mootiro.animate({
                      width: closed_panel_width,
                      height: closed_panel_height
                  });
                }, 2000);
            });
            $("#about-mootiro.open").live("mouseenter", function (evt) {
                // Don't close the panel when the mouse goes out and then come back
                if (close_panel) {
                    clearTimeout(close_panel);
                }
            });

            var entity_image= {
                'community': {
                    on: '{{STATIC_URL}}img/community.png',
                    off: '{{STATIC_URL}}img/community-off.png'
                },
                'need': {
                    on: '{{STATIC_URL}}img/need.png',
                    off: '{{STATIC_URL}}img/need-off.png'
                },
                'organization': {
                    on: '{{STATIC_URL}}img/organization.png',
                    off: '{{STATIC_URL}}img/organization-off.png'
                },
                'resource': {
                    on: '{{STATIC_URL}}img/resource.png',
                    off: '{{STATIC_URL}}img/resource-off.png'
                },
                'investment': {
                    on: '{{STATIC_URL}}img/investment.png',
                    off: '{{STATIC_URL}}img/investment-off.png'
                }
            };

            $('.frontpage-filter-item').click(function(){
                var that = $(this);
                var img = that.find('img').first();
                if (that.is('.active-filter')) {
                    img.attr('src', entity_image[img.attr('alt')].off);
                    that.removeClass('active-filter');
                } else {
                    img.attr('src', entity_image[img.attr('alt')].on);
                    that.addClass('active-filter');
                }
                var apps = [];
                $('.frontpage-filter-item.active-filter').each(function(idx, obj){
                    apps.push($(obj).find('img').first().attr('alt'));
                });
                window.location = window.location.pathname + '?filters=' + apps.join();
            });

            // Fix active filters list
            var url_vars = getUrlVars();
            if (url_vars && url_vars['filters']) {
                var filters = url_vars['filters'].split(',');
                $('.frontpage-filter-item').each(function(idx, obj){
                    var that = $(this);
                    var img = that.find('img').first();
                    if (filters.indexOf(img.attr('alt')) === -1) {
                        img.attr('src', entity_image[img.attr('alt')].off);
                        that.removeClass('active-filter');
                    }
                });
            }

            var uri_query = window.location.search;
            uri_query = uri_query.substring(1, uri_query.length);
            if (uri_query.length) {
                $('.komoo-pagination a').each(function(idx, obj){
                    var el = $(obj);
                    var href = el.attr('href');
                    el.attr('href', href + '&' +  uri_query);
                });
            }

        });

    </script>
{% endblock %}
