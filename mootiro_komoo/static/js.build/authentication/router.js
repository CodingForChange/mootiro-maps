var __hasProp=Object.prototype.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};define(["require","jquery","underscore","backbone","reForm","./views","new_utils","text!templates/authentication/_not_verified.html","text!templates/authentication/_verified.html"],function(e){var t,n,r,i,s,o,u,a,f;return t=e("jquery"),f=e("underscore"),n=e("backbone"),o=e("reForm"),a=e("./views"),i=e("new_utils"),s=e("text!templates/authentication/_not_verified.html"),u=e("text!templates/authentication/_verified.html"),r=function(e){function n(){n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.routes={"":"root",login:"login",register:"register","not-verified":"not_verified",verified:"verified"},n.prototype.initialize=function(e){return this.options=e,f.bindAll(this),this.initializeLogin(),this.initializeLogout(),this.initializeRegister(),this.initializeVerification(),this.bindExternalEvents()},n.prototype._onClose=function(){return this.navigate("",{})},n.prototype._loginRequired=function(e){if(typeof KomooNS!="undefined"&&KomooNS!==null?!KomooNS.isAuthenticated:!void 0)return e&&this.loginView.updateUrls(e),this.navigate("login",{trigger:!0})},n.prototype.bindExternalEvents=function(){return this.vent=this.options.vent,this.vent.on("auth:loginRequired",this._loginRequired),this.vent.on("auth:logout",this.logoutView.logout)},n.prototype.initializeLogin=function(){var e=this;return this.loginView=new a.LoginView({}),this.loginView.form.on("register-link:click",this.registerLinkCB),this.loginBox=new i.ModalBox({title:i18n("Login"),content:this.loginView.render().el,modal_id:"login-modal-box"}),this.loginBox.on("close",this._onClose),t("a.login-required").bind("click.loginrequired",function(n){var r;if(typeof KomooNS!="undefined"&&KomooNS!==null?!KomooNS.isAuthenticated:!void 0)return n.preventDefault(),r=t(n.target).attr("href"),(r!=null?r.charAt(0):void 0)==="#"&&(r=document.location.pathname+r),e._loginRequired(r),!1})},n.prototype.initializeLogout=function(){return this.logoutView=new a.LogoutView({})},n.prototype.initializeRegister=function(){return this.registerView=new a.RegisterView({}),this.registerView.form.on("success",this.registerFormOnSuccessCB),this.registerView.form.on("login-link:click",this.loginLinkCB),this.registerBox=new i.ModalBox({title:i18n("Register"),width:"450px",content:this.registerView.render().el,modal_id:"register-modal-box"}),this.registerBox.on("close",this._onClose)},n.prototype.initializeVerification=function(){return this.notVerifiedView=new a.VerificationView({verified:!1}),this.verifiedView=new a.VerificationView({verified:!0}),this.verifiedView.loginForm.on("register-link:click",this.registerLinkCB),this.notVerifiedBox=new i.ModalBox({title:i18n("Verification"),content:this.notVerifiedView.render().el,modal_id:"verification-modal-box"}),this.notVerifiedBox.on("close",this._onClose),this.verifiedBox=new i.ModalBox({title:i18n("Verification"),content:this.verifiedView.render().el,modal_id:"verification-modal-box"}),this.verifiedBox.on("close",this._onClose)},n.prototype.registerLinkCB=function(){return this.navigate("register",{trigger:!0})},n.prototype.loginLinkCB=function(){return this.navigate("login",{trigger:!0})},n.prototype.registerFormOnSuccessCB=function(){return this.navigate("not-verified",{trigger:!0})},n.prototype.root=function(){var e,t,n,r;t=window.location.pathname;if((t==="/user/"||t==="/user")&&(typeof KomooNS!="undefined"&&KomooNS!==null?!KomooNS.isAuthenticated:!void 0))return r=window.location,r.search&&r.search.indexOf("next")>-1&&(n={},r.search.replace(new RegExp("([^?=&]+)(=([^&]*))?","g"),function(e,t,r,i){return n[t]=i}),e=n.next,this.loginView.updateUrls(e)),this.navigate("login",{trigger:!0})},n.prototype.login=function(){return this.closeModals("login"),(typeof KomooNS!="undefined"&&KomooNS!==null?!KomooNS.isAuthenticated:!void 0)?this.loginBox.open():this.navigate("",{trigger:!0})},n.prototype.register=function(){return this.closeModals("register"),(typeof KomooNS!="undefined"&&KomooNS!==null?!KomooNS.isAuthenticated:!void 0)?this.registerBox.open():this.navigate("",{trigger:!0})},n.prototype.not_verified=function(){var e;return this.closeModals("not-verified"),e=window.location.pathname,this.notVerifiedBox.open()},n.prototype.verified=function(){var e;return this.closeModals("verified"),e=window.location.pathname,this.verifiedBox.open()},n.prototype.closeModals=function(e){var t,n,r,i;i=[this.loginBox,this.registerBox,this.verifiedBox,this.notVerifiedBox];for(n=0,r=i.length;n<r;n++)t=i[n],t.close();return this.navigate(e)},n}(n.Router),{LoginApp:r}})