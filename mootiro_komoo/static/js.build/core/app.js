(function(){define(["require","jquery","backbone","storage","user/models","main/views"],function(e){var t,n,r,i,s,o;return i=e("jquery"),n=e("backbone"),o=e("storage"),r=e("user/models").User,s=e("main/views"),t=function(){function t(){$.when(this.handleModulesError(),this.interceptAjaxRequests(),this.initializeUser(),this.drawLayout(),this.initializeRouters(),this.initializeAnalytics()).done(function(){return n.trigger("initialize")})}return t.prototype.handleModulesError=function(){return requirejs.onError=function(e){if(e.requireType!=="timeout")throw e;return alert("Timeout: Ocorreu uma falha ao carregar alguns serviços externos. Partes do Mootiro Maps poderão não funcionar corretamente."),n.trigger("error",e)},!0},t.prototype.interceptAjaxRequests=function(){var e,t,r;return r=function(e){var t,n,r,i;return t=document.location.host,r=document.location.protocol,i="//"+t,n=r+i,e===n||e.slice(0,n.length+1)===n+"/"||e===i||e.slice(0,i.length+1)===i+"/"||!/^(\/\/|http:|https:).*/.test(e)},t=function(e){return/^(GET|HEAD|OPTIONS|TRACE)$/.test(e)},i(document).ajaxSend(function(e,n,i){if(!t(i.type)&&r(i.url))return n.setRequestHeader("X-CSRFToken",o.cookie.get("csrftoken"))}),e=o.cookie.get("sessionid"),i(document).ajaxSuccess(function(t,i,s){var u;return u=o.cookie.get("sessionid"),r(s.url)&&e!==u&&n.trigger("change:session",u),e=u}),i(document).ajaxStart(function(){return n.trigger("working")}),i(document).ajaxStop(function(){return n.trigger("done")}),!0},t.prototype.initializeUser=function(){return KomooNS.isAuthenticated?KomooNS.user=new r(KomooNS.user_data):KomooNS.user=new r({}),n.on("change:session",function(e){return KomooNS.user.clear(),KomooNS.user.set("id","me"),KomooNS.user.fetch({success:function(e){return KomooNS.isAuthenticated=e.get("id")!==null,e.trigger("change")}})}),!0},t.prototype.drawLayout=function(){var e,t,n;return $("body").prepend($('<div id="fb-root" />')),e=new s.Feedback({el:"#feedback-container"}),n=new s.Header({el:"#header-container",model:KomooNS.user}),t=new s.Footer({el:"#footer-container"}),!0},t.prototype.initializeRouters=function(){var t,r=this;return t=new $.Deferred,this.routers=[],$(function(){return e(["main/router","authentication/router","user/router"],function(){var e,i,s;for(i=0,s=arguments.length;i<s;i++)e=arguments[i],r.routers.push(new e);return n.history.start({pushState:!0,root:"/"}),t.resolve(!0)})}),t.promise()},t.prototype.initializeAnalytics=function(){var t;return t=new $.Deferred,$(function(){return e(["services/analytics"],function(e){return t.resolve(e.initialize())})}),t.promise()},t}(),{App:t}})}).call(this);