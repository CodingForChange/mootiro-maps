(function(){define(["jquery","utils"],function(e){return e(function(){var t,n,r,i,s,o,u,a;n=e("#search"),i=e("#search-bar"),t=getCookie("csrftoken")||window.csrf_token,u={community:gettext("Communities"),need:gettext("Needs"),organization:gettext("Organizations"),resource:gettext("Resources"),investiment:gettext("Investments"),google:gettext("Google Results"),user:gettext("User"),project:gettext("Project")},s=function(){return e("#search-results-box").popover("show"),e(".popover").css("top",parseInt(e(".popover").css("top"),10)-10),e(".popover").css("left",parseInt(e(".popover").css("left"),10)-75)},window.seeOnMap=function(t){var n,r;return window.location.pathname===dutils.urls.resolve("map")?(t[0]==="g"?(n=parseInt(t.substring(1,t.length),10),r=setInterval(function(){var e;try{return e=JSON.parse(localStorageGet("komoo_search").results.google).predictions[n].description,editor.goTo(e),clearInterval(r)}catch(t){}},500)):e.get("/map/get_geojson_from_hashlink/",{hashlink:t},function(e){var t;return t=JSON.parse(e.geojson),r=setInterval(function(){try{return editor.loadGeoJSON(t,!0),clearInterval(r)}catch(e){}},500)},"json"),e("#search-results-box").popover("hide")):window.location=dutils.urls.resolve("map")+("#"+t)},o=function(t){var n,r,i,o,a,f,l,c,h,p,d,v,m,g,y,b,w,E;d="",p=0,o=!1,h=["community","project","organization","need","resource","user"];for(m=0,y=h.length;m<y;m++){l=h[m],v=t[l];if((v!=null?v.length:void 0)&&l!=="google"){d+="<li>\n<div class='search-header "+l+"' >\n    <img src='/static/img/"+l+".png' >\n    <div class='search-type-header' >\n        "+u[l]+"\n        <span class='search-results-count'>\n            "+interpolate(ngettext("%s result","%s results",v.length),[v.length])+"\n        </span>\n    </div>\n</div>\n<ul class='search-result-entries'>";for(f in v){c=v[f],r=(c!=null?!c.has_geojson:!void 0)?"disabled":"",a=l[0]+c.id,d+='<li class="search-result">\n    <a class="search-result-title" href=\''+c.link+"'> "+c.name+' </a>\n    <div class="right">\n        <a href="/map/#'+a+'" hashlink="'+a+'" class="search-map-link '+r+'"><i class="icon-see-on-map"></i></a>\n    </div>\n</li>';if(l==="organization"&&((w=c.branches)!=null?w.length:void 0)){E=c.branches;for(g=0,b=E.length;g<b;g++)n=E[g],d+='<li class="branch-search-result">\n    <span class="search-result-title org-branch">&#8226; '+n.name+'</span>\n    <div class="right">\n        <a href="/map/#b'+n.id+'" hashlink="b'+n.id+'" class="search-map-link"><i class="icon-see-on-map"></i></a>\n    </div>\n</li>'}p++}d+="</ul></li>",o|=!0}else o|=!1}i=JSON.parse(t.google).predictions;if(i!=null?i.length:void 0){l="google",d+='<li>\n<div class="search-header google">\n    <img src="/static/img/'+l+'.png" >\n    <div class="search-type-header" >\n        '+u[l]+'\n        <span class="search-results-count">\n            '+interpolate(ngettext("%s result","%s results",i.length),[i.length])+'\n        </span>\n    </div>\n</div>\n<ul class="search-result-entries">';for(f in i)c=i[f],a="g"+f,d+='<li>\n    <a href="#" class="search-result-title"> '+c.description+'</a>\n    <div class="right">\n        <a href="#'+a+'" hashlink="'+a+'" class="search-map-link"><i class="icon-see-on-map"></i></a>\n    </div>\n</li>',p++;d+="</ul></li>",o|=!0}else o|=!1;return o||(d='<div class="search-no-results"> '+gettext("No results found!")+"</div>"),e("#search-results-box").data("popover").options.title=""+p+' Results <span id="search-box-close" >x</span>',e("#search-results-box").data("popover").options.content=d,s()},n.submit(function(n){var r,s;n.preventDefault(),s=i.val(),r=localStorageGet("komoo_search");if(!s)return;return(r!=null?r.term:void 0)===s?o(r.results):e.ajax({type:"POST",url:dutils.urls.resolve("komoo_search"),data:{term:s,csrfmiddlewaretoken:t},dataType:"json",success:function(e){return localStorageSet("komoo_search",{term:s,results:e.result}),o(e.result)}})}),e("#search-results-box").popover({placement:"bottom",selector:i,trigger:"manual"}),e("#search-box-close").live("click",function(){return e("#search-results-box").popover("hide")}),e(".search-map-link").live("click",function(t){var n;return t.preventDefault(),n=e(this),n.is(".disabled")?!1:seeOnMap(n.attr("hashlink"))}),i.val(((a=localStorageGet("komoo_search"))!=null?a.term:void 0)||"");if(window.location.pathname===dutils.urls.resolve("map")){r=window.location.hash;if(r)return seeOnMap(r.substring(1,r.length))}})})}).call(this)