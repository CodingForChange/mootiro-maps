(function(){define(["jquery","canvasloader","utils","bootstrap"],function(e,t){return e(function(){var n,r,i,s,o,u,a,f,l;i=e("#search"),o=e("#search-bar"),r=getCookie("csrftoken")||window.csrf_token,n=new t("search-canvasloader-container"),n.setColor("#3ebac2"),n.setShape("rect"),n.setDiameter(22),n.setDensity(43),n.setRange(1.2),n.setFPS(22),f={community:gettext("Communities"),need:gettext("Needs"),organization:gettext("Organizations"),resource:gettext("Resources"),investiment:gettext("Investments"),google:gettext("Google Results"),user:gettext("User"),project:gettext("Project")},u=function(){return e("#search-results-box").popover("show"),e(".popover").css("top",parseInt(e(".popover").css("top"),10)-10),e(".popover").css("left",parseInt(e(".popover").css("left"),10)-75)},window.seeOnMap=function(t){var n,r;return window.location.pathname===dutils.urls.resolve("map")?(t[0]==="g"?(n=parseInt(t.substring(1,t.length),10),r=setInterval(function(){var e;try{return e=JSON.parse(localStorageGet("komoo_search").results.google).predictions[n].description,editor.goTo(e),clearInterval(r)}catch(t){}},500)):e.get("/map/get_geojson_from_hashlink/",{hashlink:t},function(e){var t;return t=JSON.parse(e.geojson),r=setInterval(function(){try{return editor.loadGeoJSON(t,!0),clearInterval(r)}catch(e){}},500)},"json"),e("#search-results-box").popover("hide")):window.location=dutils.urls.resolve("map")+("#"+t)},a=function(t){var r,i,s,o,a,l,c,h,p,d,v,m,g,y,b,w,E,S;v="",d=0,o=!1,p=["community","project","organization","need","resource","user"];for(g=0,b=p.length;g<b;g++){c=p[g],m=t[c];if((m!=null?m.length:void 0)&&c!=="google"){v+="<li>\n<div class='search-header "+c+"' >\n    <img src='/static/img/"+c+".png' >\n    <div class='search-type-header' >\n        "+f[c]+"\n        <span class='search-results-count'>\n            "+interpolate(ngettext("%s result","%s results",m.length),[m.length])+"\n        </span>\n    </div>\n</div>\n<ul class='search-result-entries'>";for(l in m){h=m[l],i=(h!=null?!h.has_geojson:!void 0)?"disabled":"",a=c[0]+h.id,v+='<li class="search-result">\n    <a class="search-result-title" href=\''+h.link+"'> "+h.name+' </a>\n    <div class="right">\n        <a href="/map/#'+a+'" hashlink="'+a+'" class="search-map-link '+i+'"><i class="icon-see-on-map"></i></a>\n    </div>\n</li>';if(c==="organization"&&((E=h.branches)!=null?E.length:void 0)){S=h.branches;for(y=0,w=S.length;y<w;y++)r=S[y],v+='<li class="branch-search-result">\n    <span class="search-result-title org-branch">&#8226; '+r.name+'</span>\n    <div class="right">\n        <a href="/map/#b'+r.id+'" hashlink="b'+r.id+'" class="search-map-link"><i class="icon-see-on-map"></i></a>\n    </div>\n</li>'}d++}v+="</ul></li>",o|=!0}else o|=!1}s=JSON.parse(t.google).predictions;if(s!=null?s.length:void 0){c="google",v+='<li>\n<div class="search-header google">\n    <img src="/static/img/'+c+'.png" >\n    <div class="search-type-header" >\n        '+f[c]+'\n        <span class="search-results-count">\n            '+interpolate(ngettext("%s result","%s results",s.length),[s.length])+'\n        </span>\n    </div>\n</div>\n<ul class="search-result-entries">';for(l in s)h=s[l],a="g"+l,v+='<li>\n    <a href="#" class="search-result-title"> '+h.description+'</a>\n    <div class="right">\n        <a href="#'+a+'" hashlink="'+a+'" class="search-map-link"><i class="icon-see-on-map"></i></a>\n    </div>\n</li>',d++;v+="</ul></li>",o|=!0}else o|=!1;return o||(v='<div class="search-no-results"> '+gettext("No results found!")+"</div>"),e("#search-results-box").data("popover").options.title=""+d+' Results <span id="search-box-close" >x</span>',e("#search-results-box").data("popover").options.content=v,u(),n!=null?n.hide():void 0},i.submit(function(t){var i,s;t.preventDefault(),s=o.val(),i=localStorageGet("komoo_search");if(!s)return;return n!=null&&n.show(),(i!=null?i.term:void 0)===s?a(i.results):e.ajax({type:"POST",url:dutils.urls.resolve("komoo_search"),data:{term:s,csrfmiddlewaretoken:r},dataType:"json",success:function(e){return localStorageSet("komoo_search",{term:s,results:e.result}),a(e.result)}})}),e("#search-results-box").popover({placement:"bottom",selector:o,trigger:"manual"}),e("#search-box-close").live("click",function(){return e("#search-results-box").popover("hide")}),e(".search-map-link").live("click",function(t){var n;return t.preventDefault(),n=e(this),n.is(".disabled")?!1:seeOnMap(n.attr("hashlink"))}),o.val(((l=localStorageGet("komoo_search"))!=null?l.term:void 0)||"");if(window.location.pathname===dutils.urls.resolve("map")){s=window.location.hash;if(s)return seeOnMap(s.substring(1,s.length))}})})}).call(this)