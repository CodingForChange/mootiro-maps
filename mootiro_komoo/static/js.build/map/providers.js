var __hasProp=Object.prototype.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};define(["googlemaps","map/component"],function(e,t){var n,r,i;return window.komoo==null&&(window.komoo={}),(i=window.komoo).event==null&&(i.event=e.event),r=function(t){function n(){n.__super__.constructor.apply(this,arguments)}return __extends(n,t),n.prototype.name="Generic Provider",n.prototype.alt="Generic Data Provider",n.prototype.tileSize=new e.Size(256,256),n.prototype.maxZoom=32,n.prototype.enabled=!0,n.prototype.init=function(e){return this.options=e,this.addrLatLngCache={},this.fetchedTiles={}},n.prototype.setMap=function(e){return this.map=e,this.map.googleMap.overlayMapTypes.insertAt(0,this),typeof this.handleMapEvents=="function"?this.handleMapEvents():void 0},n.prototype.enable=function(){return this.enabled=!0},n.prototype.disable=function(){return this.enabled=!1},n.prototype.getAddrLatLng=function(t,n){var r,i,s,o,u,a,f;return r="x="+t.x+",y="+t.y+",z="+n,this.addrLatLngCache[r]?this.addrLatLngCache[r]:(s=1<<n,a=this.map.googleMap.getProjection(),o=new e.Point((t.x+1)*this.tileSize.width/s,t.y*this.tileSize.height/s),u=new e.Point(t.x*this.tileSize.width/s,(t.y+1)*this.tileSize.height/s),i=a.fromPointToLatLng(o),f=a.fromPointToLatLng(u),this.addrLatLngCache[r]="bounds="+i.toUrlValue()+","+f.toUrlValue()+"&zoom="+n)},n}(t),n=function(e){function t(){t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.name="Feature Provider",t.prototype.alt="Feature Provider",t.prototype.fetchUrl="/get_geojson?",t.prototype.init=function(e){return t.__super__.init.call(this,e),this.keptFeatures=komoo.collections.makeFeatureCollection()},t.prototype.handleMapEvents=function(){var e=this;return this.map.subscribe("idle",function(){var t;if(e.enabled===!1)return;return t=e.map.googleMap.getBounds(),e.keptFeatures.forEach(function(e){if(!t.intersects(e.getBounds()))return e.setMap(null)}),e.keptFeatures.clear()})},t.prototype.releaseTile=function(e){var t,n=this;if(this.enabled===!1)return;if(this.fetchedTiles[e.addr])return t=this.map.getBounds(),this.fetchedTiles[e.addr].features.forEach(function(e){if(e.getBounds){if(!t.intersects(e.getBounds()))return e.setMap(null);if(!t.contains(e.getBounds().getNorthEast()||!t.contains(e.getBounds().getSouthWest())))return n.keptFeatures.push(e),e.setMap(n.map)}else if(e.getPosition&&!t.contains(e.getPosition()))return e.setMap(null)})},t.prototype.getTile=function(e,t,n){var r,i,s=this;return i=n.createElement("DIV"),r=this.getAddrLatLng(e,t),i.addr=r,this.enabled===!1?i:this.fetchedTiles[r]?(this.fetchedTiles[r].features.setMap(this.map),i):($.ajax({url:this.fetchUrl+r,dataType:"json",type:"GET",success:function(e){var t;return t=s.map.loadGeoJSON(JSON.parse(e),!1),s.fetchedTiles[r]={geojson:e,features:t},t.setMap(s.map)},error:function(e,t){var n,r;return typeof console!="undefined"&&console!==null&&console.error(t),r=$("#server-error"),r.parent().length===0&&(r=$("<div>").attr("id","server-error"),$("body").append(r)),n=$("<div>").html(e.responseText),r.append(n)}}),i)},t}(r),window.komoo.providers={GenericProvider:r,FeatureProvider:n,makeFeatureProvider:function(e){return new n(e)}},window.komoo.providers})