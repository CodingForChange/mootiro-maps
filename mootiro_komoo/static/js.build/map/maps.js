var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp=Object.prototype.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e},__indexOf=Array.prototype.indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};define(["googlemaps","underscore","map/core","map/collections","map/features","map/geometries"],function(e,t,n,r,i,s){var o,u,a,f,l,c,h,p;return window.komoo==null&&(window.komoo={}),(p=window.komoo).event==null&&(p.event=e.event),f=function(n){function o(e){var t,n,i,s,u=this;this.options=e!=null?e:{},this.addFeature=__bind(this.addFeature,this),o.__super__.constructor.call(this),this.initialized=this.data.deferred(),this.element=(s=this.options.element)!=null?s:document.getElementById(this.options.elementId),this.el=this.element,this.features=r.makeFeatureCollectionPlus({map:this}),this.components={},this.addComponent("map/controls::Location"),i=this.initGoogleMap(this.options.googleMapOptions),t=this.initFeatureTypes(),n=this.handleEvents(),this.data.when(i,t,n).done(function(){return u.initialized.resolve()})}return __extends(o,n),o.prototype.featureTypesUrl="/map_info/feature_types/",o.prototype.googleMapDefaultOptions={zoom:12,center:new e.LatLng(-23.55,-46.65),disableDefaultUI:!1,streetViewControl:!0,scaleControl:!0,panControlOptions:{position:e.ControlPosition.RIGHT_TOP},zoomControlOptions:{position:e.ControlPosition.RIGHT_TOP},scaleControlOptions:{position:e.ControlPosition.RIGHT_BOTTOM,style:e.ScaleControlStyle.DEFAULT},mapTypeControlOptions:{mapTypeIds:[e.MapTypeId.ROADMAP,e.MapTypeId.HYBRID]},mapTypeId:e.MapTypeId.HYBRID},o.prototype.addControl=function(e,t){return this.googleMap.controls[e].push(t)},o.prototype.loadGeoJsonFromOptons=function(){var e=this;return this.data.when(this.initialized).done(function(){var t,n;if(e.options.geojson)return n=e.loadGeoJSON(e.options.geojson,e.options.zoom==null),t=n.getBounds(),t!=null&&e.fitBounds(t),n!=null&&n.setMap(e,{geometry:!0,icon:!0}),e.publish("set_zoom",e.options.zoom),e.publish("features_loaded_from_options",n)})},o.prototype.initGoogleMap=function(t){return t==null&&(t=this.googleMapDefaultOptions),this.googleMap=new e.Map(this.element,t),this.handleGoogleMapEvents(),$(this.element).trigger("initialized",this)},o.prototype.handleGoogleMapEvents=function(){var e,t=this;return e=["click","idle"],e.forEach(function(e){return komoo.event.addListener(t.googleMap,e,function(n){return t.publish(e,n)})})},o.prototype.initFeatureTypes=function(){var e,t,n=this;return e=this.data.deferred(),this.featureTypes==null&&(this.featureTypes={}),this.options.featureTypes!=null?((t=this.options.featureTypes)!=null&&t.forEach(function(e){return n.featureTypes[e.type]=e}),this.loadGeoJsonFromOptons(),e.resolve()):$.ajax({url:this.featureTypesUrl,dataType:"json",success:function(t){return t.forEach(function(e){return n.featureTypes[e.type]=e}),n.loadGeoJsonFromOptons(),e.resolve()}}),e.promise()},o.prototype.handleEvents=function(){var t=this;return this.subscribe("features_loaded",function(e){return komoo.event.trigger(t,"features_loaded",e)}),this.subscribe("close_clicked",function(){return komoo.event.trigger(t,"close_click")}),this.subscribe("drawing_started",function(e){return komoo.event.trigger(t,"drawing_started",e)}),this.subscribe("drawing_finished",function(e,n){komoo.event.trigger(t,"drawing_finished",e,n);if(n===!1)return t.revertFeature(e);if(e.getProperty("id")==null)return t.addFeature(e)}),this.subscribe("set_location",function(n){var r;return n=n.split(","),r=new e.LatLng(n[0],n[1]),t.googleMap.setCenter(r)}),this.subscribe("set_zoom",function(e){return t.setZoom(e)})},o.prototype.addComponent=function(e,n,r){var i=this;return n==null&&(n="generic"),r==null&&(r={}),this.data.when(this.initialized).done(function(){return t.isString(e)?e=i.start(e,"",r):e=i.start(e),i.data.when(e).done(function(){var e,t,r,s,o;o=[];for(r=0,s=arguments.length;r<s;r++)e=arguments[r],e.setMap(i),(t=i.components)[n]==null&&(t[n]=[]),i.components[n].push(e),o.push(typeof e.enable=="function"?e.enable():void 0);return o})})},o.prototype.enableComponents=function(e){var t,n=this;return(t=this.components[e])!=null?t.forEach(function(e){return typeof e.enable=="function"?e.enable():void 0}):void 0},o.prototype.disableComponents=function(e){var t,n=this;return(t=this.components[e])!=null?t.forEach(function(e){return typeof e.disable=="function"?e.disable():void 0}):void 0},o.prototype.getComponentsStatus=function(e){var t,n,r=this;return t=[],(n=this.components[e])!=null&&n.forEach(function(e){if(e.enabled===!0)return t.push("enabled")}),__indexOf.call(t,"enabled")>=0?"enabled":"disabled"},o.prototype.clear=function(){return this.features.removeAllFromMap(),this.features.clear()},o.prototype.refresh=function(){return e.event.trigger(this.googleMap,"resize")},o.prototype.saveLocation=function(e,t){return e==null&&(e=this.googleMap.getCenter()),t==null&&(t=this.getZoom()),this.publish("save_location",e,t)},o.prototype.goToSavedLocation=function(){return this.publish("goto_saved_location"),!0},o.prototype.goToUserLocation=function(){return this.publish("goto_user_location")},o.prototype.handleFeatureEvents=function(e){var t,n=this;return t=["mouseover","mouseout","mousemove","click","dblclick","rightclick","highlight_changed"],t.forEach(function(t){return komoo.event.addListener(e,t,function(r){return n.publish("feature_"+t,r,e)})})},o.prototype.goTo=function(e,t){return t==null&&(t=!0),this.publish("goto",e,t)},o.prototype.panTo=function(e,t){return t==null&&(t=!1),this.goTo(e,t)},o.prototype.makeFeature=function(e,t){var n;return t==null&&(t=!0),n=i.makeFeature(e,this.featureTypes),t&&this.addFeature(n),this.publish("feature_created",n),n},o.prototype.addFeature=function(e){return this.handleFeatureEvents(e),this.features.push(e)},o.prototype.revertFeature=function(e){if(e.getProperty("id")==null)return e.setMap(null)},o.prototype.getFeatures=function(){return this.features},o.prototype.getFeaturesByType=function(e,t,n){return this.features.getByType(e,t,n)},o.prototype.showFeaturesByType=function(e,t,n){var r;return(r=this.getFeaturesByType(e,t,n))!=null?r.show():void 0},o.prototype.hideFeaturesByType=function(e,t,n){var r;return(r=this.getFeaturesByType(e,t,n))!=null?r.hide():void 0},o.prototype.showFeatures=function(e){return e==null&&(e=this.features),e.show()},o.prototype.hideFeatures=function(e){return e==null&&(e=this.features),e.hide()},o.prototype.centerFeature=function(e,t){var n;return n=e instanceof i.Feature?e:this.features.getById(e,t),this.panTo(n!=null?n.getCenter():void 0,!1)},o.prototype.loadGeoJson=function(e,t,n){var i,s=this;return t==null&&(t=!1),n==null&&(n=!0),i=r.makeFeatureCollection({map:this}),this.data.when(this.initialized).done(function(){var r,o;return(e!=null?e.type:void 0)==null||!e.type==="FeatureCollection"?i:((r=e.features)!=null&&r.forEach(function(e){var t;return t=s.features.getById(e.properties.type,e.properties.id),t==null&&(t=s.makeFeature(e,n)),i.push(t)}),t&&((o=i.getAt(0))!=null?o.getBounds():void 0)&&s.googleMap.fitBounds(i.getAt(0).getBounds()),s.publish("features_loaded",i))}),i},o.prototype.loadGeoJSON=function(e,t,n){return this.loadGeoJson(e,t,n)},o.prototype.getGeoJson=function(e){var t;return e==null&&(e={}),e.newOnly==null&&(e.newOnly=!1),e.currentOnly==null&&(e.currentOnly=!1),e.geometryCollection==null&&(e.geometryCollection=!1),t=e.newOnly?this.newFeatures:e.currentOnly?r.makeFeatureCollection({map:this.map,features:[this.currentFeature]}):this.features,t.getGeoJson({geometryCollection:e.geometryCollection})},o.prototype.getGeoJSON=function(e){return this.getGeoJson(e)},o.prototype.drawNewFeature=function(e,t){var n;return n=this.makeFeature({type:"Feature",geometry:{type:e},properties:{name:"New "+t,type:t}}),this.publish("draw_feature",e,n)},o.prototype.editFeature=function(e,t){var n=this;return this.data.when(this.initialized).then(function(){return e==null&&(e=n.features.getAt(0)),t!=null&&e.getGeometryType()===s.types.EMPTY?(e.setGeometry(s.makeGeometry({geometry:{type:t}})),n.publish("draw_feature",t,e)):n.publish("edit_feature",e)})},o.prototype.setMode=function(e){return this.mode=e,this.publish("mode_changed",this.mode)},o.prototype.selectCenter=function(e,t){return this.selectPerimeter(e,t)},o.prototype.selectPerimeter=function(e,t){return this.publish("select_perimeter",e,t)},o.prototype.highlightFeature=function(){return this.centerFeature.apply(this,arguments),this.features.highlightFeature.apply(this.features,arguments)},o.prototype.getBounds=function(){return this.googleMap.getBounds()},o.prototype.setZoom=function(e){if(e!=null)return this.googleMap.setZoom(e)},o.prototype.getZoom=function(){return this.googleMap.getZoom()},o.prototype.fitBounds=function(e){return e==null&&(e=this.features.getBounds()),this.googleMap.fitBounds(e)},o}(n.Mediator),h=function(e){function t(e){t.__super__.constructor.call(this,e),this.addComponent("map/maptypes::CleanMapType","mapType"),this.addComponent("map/controls::DrawingManager","drawing"),this.addComponent("map/controls::SearchBox")}return __extends(t,e),t}(f),a=function(e){function t(e){t.__super__.constructor.call(this,e),this.addComponent("map/maptypes::CleanMapType"),this.addComponent("map/controls::SaveLocation"),this.addComponent("map/controls::StreetView"),this.addComponent("map/controls::DrawingManager"),this.addComponent("map/controls::DrawingControl"),this.addComponent("map/controls::GeometrySelector"),this.addComponent("map/controls::SupporterBox"),this.addComponent("map/controls::PerimeterSelector"),this.addComponent("map/controls::SearchBox")}return __extends(t,e),t}(f),l=function(t){function n(){n.__super__.constructor.apply(this,arguments)}return __extends(n,t),n.prototype.googleMapDefaultOptions={zoom:12,center:new e.LatLng(-23.55,-46.65),disableDefaultUI:!0,streetViewControl:!1,scaleControl:!0,scaleControlOptions:{position:e.ControlPosition.RIGHT_BOTTOM,style:e.ScaleControlStyle.DEFAULT},mapTypeId:e.MapTypeId.HYBRID},n}(f),c=function(e){function t(e){t.__super__.constructor.call(this,e),this.addComponent("map/maptypes::CleanMapType","mapType"),this.addComponent("map/controls::AutosaveLocation"),this.addComponent("map/controls::StreetView"),this.addComponent("map/controls::Tooltip","tooltip"),this.addComponent("map/controls::InfoWindow","infoWindow"),this.addComponent("map/controls::SupporterBox"),this.addComponent("map/controls::LicenseBox"),this.addComponent("map/controls::SearchBox")}return __extends(t,e),t.prototype.loadGeoJson=function(e,n,r){var i,s=this;return n==null&&(n=!1),r==null&&(r=!0),i=t.__super__.loadGeoJson.call(this,e,n,r),i.forEach(function(e){return e.setMap(s,{geometry:!0})}),i},t}(f),u=function(e){function t(e){t.__super__.constructor.call(this,e),this.addComponent("map/providers::FeatureProvider","provider"),this.addComponent("map/controls::FeatureClusterer","clusterer",{featureType:"Community",map:this})}return __extends(t,e),t}(c),o=function(e){function t(e){var n;t.__super__.constructor.call(this,e),this.addComponent("map/controls::DrawingManager"),this.addComponent("map/controls::DrawingControl"),this.addComponent("map/controls::GeometrySelector"),this.addComponent("map/controls::PerimeterSelector"),console.log(e),(e!=null?(n=e.geojson)!=null?n.features:void 0:void 0)||this.goToSavedLocation()||this.goToUserLocation()}return __extends(t,e),t}(u),window.komoo.maps={Map:f,Preview:l,AjaxMap:u,makeMap:function(e){var t,n;e==null&&(e={}),t=(n=e.type)!=null?n:"map";if(t==="main")return new o(e);if(t==="editor")return new a(e);if(t==="view")return new u(e);if(t==="static")return new c(e);if(t==="preview"||t==="tooltip")return new l(e);if(t==="userEditor")return new h(e)}},window.komoo.maps})