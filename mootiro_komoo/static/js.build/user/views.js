(function(){var e=Object.prototype.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};define(["require","jquery","underscore","backbone","reForm","main/views","./forms","text!templates/user/_user_info.html","text!templates/user/_profile.html","map/views","text!templates/user/_sidebar.html","text!templates/user/_update_item.html","text!templates/user/_updates_block.html","widgets/list"],function(e){var n,r,i,s,o,u,a,f,l,c,h,p;return n=e("jquery"),p=e("underscore"),i=e("backbone"),o=e("reForm"),r=e("main/views").ActionBar,c=e("./forms").UserInfoForm,l=function(n){function r(){r.__super__.constructor.apply(this,arguments)}return t(r,n),r.prototype.initialize=function(){return p.bindAll(this),this.template=p.template(e("text!templates/user/_user_info.html")),this.listenTo(this.model,"change",this.render),this.render()},r.prototype.render=function(){return this.$el.html(this.template({user:this.model.toJSON()}))},r}(i.View),s=function(n){function r(){r.__super__.constructor.apply(this,arguments)}return t(r,n),r.prototype.initialize=function(){var t,n,r,i;window.model=this.model,p.bindAll(this),this.template=p.template(e("text!templates/user/_profile.html")),this.subViews=[],this.userInfoViews={view:new l({model:this.model})},this.model.hasPermission("edit")&&(this.userInfoViews.edit=new c({model:this.model,formId:"user-info",submit_label:i18n("Save")}),this.listenTo(this.userInfoViews.edit,"success",this.onSuccess)),r=this.userInfoViews;for(t in r)n=r[t],this.subViews.push(n);return this.updatesView=new f({collection:this.model.getUpdates()}),this.subViews.push(this.updatesView),this.setMode((i=this.options.mode)!=null?i:"view")},r.prototype.render=function(){var e,t,n,r,i;r=this.subViews;for(t=0,n=r.length;t<n;t++)e=r[t],e.$el.detach();return this.$el.html(this.template({user:this.model.toJSON(),mode:this.mode})),this.$("#user-info-container").append((i=this.userInfoViews[this.mode])!=null?i.$el:void 0),this.$("#user-updates-container").append(this.updatesView.$el),this},r.prototype.setMode=function(e){this.mode=e;if(!this.model.hasPermission(this.mode)||this.userInfoViews[this.mode]==null){typeof console!="undefined"&&console!==null&&console.log("Mode '"+this.mode+"' not allowed, changing to 'view'."),i.trigger("user::profile",this.model.id);return}return this.userInfoViews[this.mode].render(),this.render()},r.prototype.onSuccess=function(){return i.trigger("user::profile",this.model.id)},r}(i.View),h=e("map/views"),u=function(n){function r(){r.__super__.constructor.apply(this,arguments)}return t(r,n),r.prototype.initialize=function(){return p.bindAll(this),this.template=p.template(e("text!templates/user/_sidebar.html")),this.subViews=[],this.mapPreview=new h.Preview({model:this.model}),this.subViews.push(this.mapPreview),this.render()},r.prototype.render=function(){var e,t,n,r;r=this.subViews;for(t=0,n=r.length;t<n;t++)e=r[t],e.$el.detach();return this.$el.html(this.template({user:this.model.toJSON()})),this.$(".map.box").append(this.mapPreview.$el),this},r}(i.View),a=function(n){function r(){r.__super__.constructor.apply(this,arguments)}return t(r,n),r.prototype.tagName="li",r.prototype.events={"click .see-on-map":"seeOnMap"},r.prototype.initialize=function(){return p.bindAll(this),this.template=p.template(e("text!templates/user/_update_item.html")),this.listenTo(this.model,"change",this.render),this.render()},r.prototype.render=function(){var e,t;return this.$el.removeClass().addClass([(e=this.model.get("type"))!=null?e.toLowerCase():void 0,(t=this.model.get("action"))!=null?t.toLowerCase():void 0]),this.$el.html(this.template({update:this.model.toJSON()})),this},r.prototype.seeOnMap=function(e){return e!=null&&typeof e.preventDefault=="function"&&e.preventDefault(),i.trigger("map::see-on-map",this.model),this},r}(i.View),f=function(n){function r(){r.__super__.constructor.apply(this,arguments)}return t(r,n),r.prototype.events={"click a.previous":"previousPage","click a.next":"nextPage","keypress .current-page":"goTo"},r.prototype.initialize=function(){var t;return p.bindAll(this),this.template=p.template(e("text!templates/user/_updates_block.html")),t=e("widgets/list"),this.listView=new t({collection:this.collection,className:"updates list",ItemView:a}),this.subViews=[this.listView],this.listenTo(this.collection,"reset",this.update),this.render()},r.prototype.render=function(){return this.listView.$el.detach(),this.$el.html(this.template(this.collection)),this.$(".list-container").prepend(this.listView.$el),this},r.prototype.update=function(){return this.$(".current-page").val(this.collection.currentPage+1),this.$(".total-pages").text(this.collection.totalPages),this.collection.currentPage===0?this.$(".previous").addClass("disabled"):this.$(".previous").removeClass("disabled"),this.collection.currentPage===this.collection.totalPages-1?this.$(".next").addClass("disabled"):this.$(".next").removeClass("disabled")},r.prototype.previousPage=function(e){return e!=null&&typeof e.preventDefault=="function"&&e.preventDefault(),this.collection.currentPage>this.collection.firstPage&&this.collection.requestPreviousPage(),this},r.prototype.nextPage=function(e){return e!=null&&typeof e.preventDefault=="function"&&e.preventDefault(),this.collection.currentPage<this.collection.totalPages-1&&this.collection.requestNextPage(),this},r.prototype.goTo=function(e){var t;if(e.keyCode!==13)return;t=parseInt(this.$(".current-page").val(),10);if(p.isNaN(t)||t<=0||t>this.collection.totalPages){this.update();return}return this.collection.goTo(t-1)},r}(i.View),{Profile:s,Updates:f,ActionBar:r,Sidebar:u}})}).call(this);